<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tạo file luyện viết Kanji</title>
    <meta name="description" content="Công cụ tạo file tập viết Kanji, Hiragana, Katakana miễn phí.">
    <meta property="og:title" content="Luyện viết Kanji - Phá Đảo Tiếng Nhật">
    <meta property="og:description" content="Tạo file PDF tự luyện viết Kanji tại nhà cực dễ dàng.">
    <meta property="og:image" content="https://i.ibb.co/dwSNXWnX/2434753923115317823.jpg">
    <meta property="og:url" content="https://phadaotiengnhat.com">
    <!--icon-->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E⛩️%3C/text%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;700&display=swap');
      
      /* --- TRACING STYLE --- */
      .kanji-trace {
        font-family: 'Klee One', 'KanjiStrokeOrders', 'UD_Digi_Kyokasho', 'Noto_Serif_JP', serif;
        color: #bfbfbf; 
        -webkit-text-stroke: 0px white; 
        paint-order: stroke fill;
        position: relative;
        z-index: 10;
        line-height: 0;
        user-select: none;
      }

      /* --- DECOMPOSITION SVG STYLE --- */
      .decomp-svg {
        width: 100%;
        height: 100%;
        display: block;
      }
      .decomp-svg path {
        stroke: #000;
        stroke-width: 3px;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* --- INLINE REFERENCE SVG STYLE (BOX 1 FIX) --- */
      .ref-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      
      .ref-wrapper svg {
        width: 100% !important;
        height: 100% !important;
        display: block;
        transform-origin: center center;
        transform: translate(var(--guide-x, 0px), var(--guide-y, 0px)) scale(var(--guide-scale, 0.9));
      }
      
      .ref-wrapper text {
        font-size: 8px;
        fill: #999;
        font-family: sans-serif;
      }
      .ref-wrapper path {
        stroke: #000;
        stroke-width: 3px;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* --- PRINT CONFIGURATION --- */
      @media print {
        @page {
          size: A4 portrait;
          margin: 0;
        }
        
        html, body {
          width: 210mm;
          min-height: 297mm;
          margin: 0 !important;
          padding: 0 !important;
          background: white;
        }

        #root {
          width: 100%;
        }

        .no-print {
          display: none !important;
        }

        .a4-page {
          width: 210mm !important;
          height: 296mm !important; 
          margin: 0 !important;
          padding-top: 10mm !important;
          padding-bottom: 0 !important;
          page-break-after: always !important;
          overflow: hidden !important;
          box-shadow: none !important;
          border: none !important;
        }
        .print-layout-reset {
  overflow: visible !important; 
  height: auto !important;      
  display: block !important;   
}
::-webkit-scrollbar {
  display: none !important;
}
      }

      @media screen {
        body {
          background-color: #f3f4f6;
        }
        .a4-page {
          width: 210mm;
          height: 297mm;
          background: white;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
          margin-bottom: 2rem;
        }
      }
/* --- 1. CLASS ẨN THANH TRƯỢT (Dùng cho Sidebar bên ngoài) --- */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }

      /* --- 2. CLASS THANH TRƯỢT ĐẸP (Dùng cho danh sách con bên trong) --- */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px; 
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #ffffff;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #bfdbfe; 
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #60a5fa;
      }
      /* Hỗ trợ Firefox */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #bfdbfe #ffffff;
      }
      /* --- 3. CLASS THANH TRƯỢT TRONG SUỐT --- */
      .input-scrollbar::-webkit-scrollbar {
        width: 14px; 
      }
      
      /* Nền trong suốt và có margin để tránh góc bo */
      .input-scrollbar::-webkit-scrollbar-track {
        background: transparent; 
        margin-top: 8px;    
        margin-bottom: 8px; 
      }

      /* Cục lăn: Bo tròn và nằm lơ lửng ở giữa */
      .input-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; 
        border-radius: 20px;       
        border: 5px solid transparent; 
        background-clip: content-box;  
      }

      .input-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8; 
      }
/* --- ANIMATION STROKE STYLE (Dynamic Speed) --- */
      @keyframes drawStroke {
        0% { stroke-dashoffset: 500; opacity: 0; }
        10% { opacity: 1; }
        100% { stroke-dashoffset: 0; opacity: 1; }
      }
      
      @keyframes fadeInNumber {
        to { opacity: 0.7; }
      }
      
      .stroke-anim-path {
        fill: none;
        stroke: #333; 
        stroke-width: 4px; 
        stroke-linecap: round;
        stroke-linejoin: round;
        stroke-dasharray: 500; 
        stroke-dashoffset: 500;
        opacity: 0;
        /* Đã xóa thời gian cố định ở đây để điều khiển bằng Code */
        animation-name: drawStroke;
        animation-timing-function: ease-out;
        animation-fill-mode: forwards;
      }

      .stroke-number {
        font-size: 8px;
        fill: #999;
        font-family: sans-serif;
        opacity: 0; 
        animation: fadeInNumber 0.5s forwards; 
      }
      /* --- CSS ĐỔI MÀU CHỮ KHI HOVER VÀO Ô ĐẦU TIÊN --- */
      /* Khi di chuột vào ô có class 'reference-box', các đường vẽ (path) sẽ đổi màu */
      .reference-box:hover path {
        stroke: #4f46e5 !important; /* Màu xanh Indigo-600 */
        transition: stroke 0.2s ease;
      }
      
      /* Dành cho trường hợp chữ chưa tải được SVG (dạng text) */
      .reference-box:hover .kanji-trace {
        color: #4f46e5 !important; 
        transition: color 0.2s ease;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
    const removeAccents = (str) => {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d").replace(/Đ/g, "D");
};
      const { useState, useEffect, useMemo, useRef } = React;

      // --- FETCH DATA FROM GITHUB ---
const fetchDataFromGithub = async () => {
  try {
    const response = await fetch('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/kanji_db.json');
    if (!response.ok) throw new Error('Không thể tải dữ liệu');
    return await response.json();
  } catch (error) {
    console.error("Lỗi tải dữ liệu:", error);
    return null;
  }
};

      // --- UTILS & DATA FETCHING ---

      const getHex = (char) => char.codePointAt(0).toString(16).toLowerCase().padStart(5, '0');

      

    
      const fetchKanjiData = async (char) => {
        const hex = getHex(char);
        
        const sources = [
          `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`,
          `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}-Kaisho.svg`,
          `https://cdn.jsdelivr.net/gh/parsimonhi/animCJK@master/svgsKana/${hex}.svg`,
          `https://cdn.jsdelivr.net/gh/parsimonhi/animCJK@master/svgsJa/${hex}.svg`
        ];

        for (const url of sources) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const text = await res.text();
              return { success: true, svg: text, source: url };
            }
          } catch (e) {
            continue;
          }
        }
        
        return { success: false };
      };

   
      const useKanjiSvg = (char) => {
        const [state, setState] = useState({ 
          loading: true, 
          paths: [], 
          fullSvg: null, 
          failed: false 
        });
        const mounted = useRef(true);

        useEffect(() => {
          mounted.current = true;
          if (!char) return;

          setState({ loading: true, paths: [], fullSvg: null, failed: false });

          fetchKanjiData(char).then((result) => {
            if (!mounted.current) return;

            if (result.success) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(result.svg, "image/svg+xml");
              
      
              const pathElements = Array.from(doc.querySelectorAll('path'));
              const pathData = pathElements.map(p => p.getAttribute('d')).filter(d => d);
              
           
              const svgString = new XMLSerializer().serializeToString(doc.documentElement);

              setState({
                loading: false,
                paths: pathData,
                fullSvg: svgString,
                failed: false
              });
            } else {
              setState({
                loading: false,
                paths: [],
                fullSvg: null,
                failed: true
              });
            }
          });

          return () => { mounted.current = false; };
        }, [char]);

        return state;
      };

const useKanjiReadings = (char, active) => {
    const [readings, setReadings] = useState({ on: '', kun: '' });
    
    useEffect(() => {
        if (!char || !active) return;
        
        // Gọi API lấy dữ liệu từ web
        fetch(`https://kanjiapi.dev/v1/kanji/${char}`)
            .then(res => res.json())
            .then(data => {
                if (data) {
                    setReadings({
                        on: data.on_readings?.join(', ') || '---',
                        kun: data.kun_readings?.join(', ') || '---'
                    });
                }
            })
            .catch(() => setReadings({ on: '---', kun: '---' }));
    }, [char, active]);

    return readings;
};

// --- COMPONENT POPUP HOẠT HỌA (Đã chỉnh con trỏ chuột) ---
const KanjiAnimationModal = ({ char, paths, fullSvg, dbData, isOpen, onClose }) => {
    const [key, setKey] = useState(0); 
    const [strokeNumbers, setStrokeNumbers] = useState([]); 
    const [speedConfig, setSpeedConfig] = useState({ duration: 3.5, delay: 0.4 });
    const [activeSpeed, setActiveSpeed] = useState('normal'); 

    // Logic khóa cuộn
    useEffect(() => {
        if (isOpen) document.body.style.overflow = 'hidden';
        else document.body.style.overflow = 'unset';
        return () => { document.body.style.overflow = 'unset'; };
    }, [isOpen]);

    // Logic lấy số thứ tự
    useEffect(() => {
        if (fullSvg) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(fullSvg, "image/svg+xml");
            const textElements = Array.from(doc.querySelectorAll('text'));
            const numbers = textElements.map(t => ({
                value: t.textContent,
                transform: t.getAttribute('transform')
            }));
            setStrokeNumbers(numbers);
        }
    }, [fullSvg]);

    const handleReplay = (mode) => {
        let newConfig = { duration: 3.5, delay: 0.4 };
        if (mode === 'slow') newConfig = { duration: 6, delay: 0.8 };     
        if (mode === 'fast') newConfig = { duration: 1.5, delay: 0.15 };  
        setSpeedConfig(newConfig);
        setActiveSpeed(mode);
        setKey(prev => prev + 1); 
    };

    if (!isOpen) return null;

    // Logic lấy dữ liệu thông minh
    let info = {};
    if (dbData?.KANJI_DB?.[char]) info = dbData.KANJI_DB[char];
    else if (dbData?.ALPHABETS?.hiragana?.[char]) info = dbData.ALPHABETS.hiragana[char];
    else if (dbData?.ALPHABETS?.katakana?.[char]) info = dbData.ALPHABETS.katakana[char];

    return (
        <div 
            // THÊM: cursor-pointer (để hiện bàn tay khi ở vùng tối)
            className="fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200 cursor-pointer"
            onClick={onClose} 
        >
            <div 
                // THÊM: cursor-default (để chuột trở lại bình thường khi vào trong khung)
                className="bg-white rounded-2xl shadow-2xl p-5 w-[90%] max-w-sm flex flex-col items-center relative animate-in zoom-in-95 duration-200 cursor-default"
                onClick={(e) => e.stopPropagation()} 
            >
                <button 
                    onClick={onClose}
                    className="absolute top-3 right-3 p-2 bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-500 rounded-full transition-colors z-10"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>

                <div className="flex items-center justify-center gap-5 mb-3 mt-2 w-full px-2">
                    <h3 className="text-5xl font-black text-indigo-600 font-['Klee_One'] leading-none">
                        {char}
                    </h3>
                    <div className="flex flex-col items-start justify-center h-full pt-1">
                        {info.sound ? (
                            <>
                                <span className="text-xl font-black text-gray-800 uppercase font-sans tracking-wide leading-tight mb-0.5">
                                    {info.sound}
                                </span>
                                {info.meaning && (
                                    <span className="text-xs text-gray-500 font-medium font-sans italic leading-tight text-left">
                                        {info.meaning}
                                    </span>
                                )}
                            </>
                        ) : (
                            <span className="text-xs text-gray-400 font-sans">---</span>
                        )}
                    </div>
                </div>

                <div key={key} className="w-60 h-40 bg-white border border-indigo-50 rounded-xl relative mb-4 shadow-inner flex-shrink-0 flex items-center justify-center">
                    <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-20" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <line x1="50" y1="0" x2="50" y2="100" stroke="black" strokeWidth="0.5" strokeDasharray="4 4" />
                        <line x1="0" y1="50" x2="100" y2="50" stroke="black" strokeWidth="0.5" strokeDasharray="4 4" />
                    </svg>

                    <svg viewBox="0 0 109 109" className="h-full w-auto p-2">
                        {strokeNumbers.map((num, idx) => (
                            <text 
                                key={`num-${idx}`} 
                                transform={num.transform} 
                                className="stroke-number"
                                style={{ animationDelay: `${idx * speedConfig.delay}s` }} 
                            >
                                {num.value}
                            </text>
                        ))}
                        {paths.map((d, index) => (
                            <path 
                                key={`path-${index}`}
                                d={d} 
                                className="stroke-anim-path"
                                style={{ 
                                    animationDuration: `${speedConfig.duration}s`, 
                                    animationDelay: `${index * speedConfig.delay}s` 
                                }} 
                            />
                        ))}
                    </svg>
                </div>

                <div className="flex justify-center gap-2 w-full px-2">
                    <button 
                        onClick={() => handleReplay('slow')}
                        title="Tua chậm"
                        className={`py-2 px-3 rounded-lg transition-all active:scale-95 flex items-center justify-center gap-1 ${activeSpeed === 'slow' ? 'bg-indigo-100 text-indigo-700 font-bold ring-1 ring-indigo-300' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200 shadow-sm'}`}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
                        <span className="text-[10px] font-bold uppercase">Chậm</span>
                    </button>

                    <button 
                        onClick={() => handleReplay('normal')}
                        title="Vẽ lại"
                        className={`py-2 px-4 rounded-lg transition-all active:scale-95 flex items-center justify-center gap-1.5 ${activeSpeed === 'normal' ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200'}`}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                        <span className="text-[10px] font-bold uppercase">Vẽ lại</span>
                    </button>

                    <button 
                        onClick={() => handleReplay('fast')}
                        title="Tua nhanh"
                        className={`py-2 px-3 rounded-lg transition-all active:scale-95 flex items-center justify-center gap-1 ${activeSpeed === 'fast' ? 'bg-indigo-100 text-indigo-700 font-bold ring-1 ring-indigo-300' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200 shadow-sm'}`}
                    >
                        <span className="text-[10px] font-bold uppercase">Nhanh</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
                    </button>
                </div>
            </div>
        </div>
    );
};
      
 const HeaderSection = ({ char, paths, loading, failed, config, dbData }) => {
  const readings = useKanjiReadings(char, config.showOnKun);
  
  if (loading) return <div className="h-[22px] w-full animate-pulse bg-gray-100 rounded mb-1"></div>;
  if (failed) return <div className="h-[22px] w-full mb-1"></div>;

  // Thêm tiền tố dbData. vào trước các biến
const info = dbData.KANJI_DB[char] || dbData.ALPHABETS.hiragana[char] || dbData.ALPHABETS.katakana[char];

const isJLPT = dbData.KANJI_LEVELS.N5.includes(char) || 
               dbData.KANJI_LEVELS.N4.includes(char) || 
               dbData.KANJI_LEVELS.N3.includes(char) || 
               dbData.KANJI_LEVELS.N2.includes(char) || 
               dbData.KANJI_LEVELS.N1.includes(char);

  return (
    <div 
      className="flex flex-row items-end px-1 mb-1 h-[22px] overflow-hidden border-b border-transparent"
      style={{ width: '184mm', minWidth: '184mm', maxWidth: '184mm' }}
    >
      {/* 1. ÂM HÁN VIỆT + NGHĨA (Luôn hiện nếu có dữ liệu) */}
      {info && (
        <div className="flex-shrink-0 mr-4 flex items-baseline gap-2 mb-[3px]">
          <span className="font-bold text-sm leading-none text-black whitespace-nowrap uppercase">
            {info.sound}
          </span>
          {info.meaning && info.meaning.trim() !== "" && (
            <span className="text-[12px] font-normal text-black leading-none whitespace-nowrap">
              ({info.meaning})
            </span>
          )}
        </div>
      )}

      {/* 2. PHẦN LOGIC THAY ĐỔI THEO NÚT GẠT */}
      <div className="flex-1 min-w-0 h-[22px]"> 
        {(() => {
          // TRƯỜNG HỢP 1: Nếu nút gạt đang TẮT (Mặc định)
          // Hiện thứ tự nét vẽ cho TẤT CẢ các chữ (Kanji, Kana...)
          if (!config.showOnKun) {
            return (
              <div className="h-full flex items-center flex-wrap gap-1">
                {paths.map((_, i) => (
                  <div key={i} className="w-[22px] h-[22px] flex-shrink-0">
                    <svg viewBox="0 0 109 109" className="decomp-svg">
                      {paths.slice(0, i + 1).map((d, pIndex) => (
                        <path key={pIndex} d={d} />
                      ))}
                    </svg>
                  </div>
                ))}
              </div>
            );
          }

          // TRƯỜNG HỢP 2: Nếu nút gạt đang BẬT
          // A. Nếu là Kanji thuộc N1-N5: Hiện âm On/Kun
          if (isJLPT) {
            return (
              <div className="h-full flex items-end pb-[3px] text-[12px] text-black italic w-full leading-none whitespace-nowrap">
              <div className="truncate w-full">
              <span className="font-bold text-black mr-1 uppercase">On:</span>
              <span className="mr-3 not-italic font-medium">{readings.on || '---'}</span>
              <span className="font-bold text-black mr-1 uppercase">Kun:</span>
              <span className="not-italic font-medium">{readings.kun || '---'}</span>
              </div>
              </div>
            );
          }

          // B. Nếu KHÔNG phải Kanji N1-N5 (Hiragana, Katakana, chữ khác): Ẩn hoàn toàn nét vẽ
          return null;
        })()}
      </div>
    </div>
  );
};
// 2. GridBox (Đã thêm class reference-box và chỉnh Hover xanh nhạt)
const GridBox = ({ char, type, config, index, svgData, failed, onClick }) => {
    const isReference = type === 'reference';
    const showTrace = index < config.traceCount;
    const { gridType, gridOpacity } = config; 

    const gridColor = `rgba(0, 0, 0, ${gridOpacity})`;

    const refStyle = isReference ? {
        '--guide-scale': config.guideScale,
        '--guide-x': `${config.guideX}px`,
        '--guide-y': `${config.guideY}px`
    } : {};

    return (
        <div 
        // THÊM: class 'reference-box' (quan trọng để đổi màu chữ)
        // SỬA: hover:bg-indigo-50 (nền xanh nhạt)
        className={`relative w-[16mm] h-[16mm] border-r border-b box-border flex justify-center items-center overflow-hidden bg-transparent ${isReference ? 'reference-box cursor-pointer hover:bg-indigo-50 transition-colors duration-200' : ''}`}
        style={{ borderColor: gridColor }}
        onClick={isReference ? onClick : undefined} 
        title={isReference ? "Bấm để xem cách viết" : ""}
        >
        
        <div className="absolute inset-0 pointer-events-none z-0">
            {gridType !== 'blank' && (
            <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                <line x1="50" y1="0" x2="50" y2="100" stroke="black" strokeOpacity={gridOpacity} strokeWidth="0.5" strokeDasharray="4 4" />
                <line x1="0" y1="50" x2="100" y2="50" stroke="black" strokeOpacity={gridOpacity} strokeWidth="0.5" strokeDasharray="4 4" />
            </svg>
            )}
        </div>

        {char && (
            <>
            {isReference && (
                <div className="relative z-20 w-full h-full flex items-center justify-center p-[1px]">
                    {!failed && svgData ? (
                    <div className="ref-wrapper" style={refStyle} dangerouslySetInnerHTML={{ __html: svgData }} />
                    ) : (
                    <span className="kanji-trace !text-black flex justify-center items-center h-full w-full"
                        style={{ fontSize: `${config.fontSize}pt`, color: 'black', transform: `translateY(${config.verticalOffset}px)`, textShadow: 'none', webkitTextStroke: '0' }}>
                        {char}
                    </span>
                    )}
                    
                    {/* Icon bàn tay gợi ý (ẩn đi vì đã có hiệu ứng đổi màu chữ làm tín hiệu) */}
                    <div className="absolute bottom-0.5 right-0.5 opacity-0 hover:opacity-0 text-indigo-400 pointer-events-none transition-opacity">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
                    </div>
                </div>
            )}

            {!isReference && showTrace && (
                <span className="kanji-trace"
                style={{
                    fontSize: `${config.fontSize}pt`,
                    transform: `translateY(${config.verticalOffset}px)`,
                    color: `rgba(0, 0, 0, ${config.traceOpacity})`,
                    fontFamily: config.fontFamily
                }}
                >
                {char}
                </span>
            )}
            </>
        )}
        </div>
    );
};

 // 3. WorkbookRow (Cập nhật truyền props cho Modal mới)
     const WorkbookRow = ({ char, config, dbData }) => {
        const { loading, paths, fullSvg, failed } = useKanjiSvg(char);
        const boxes = Array.from({ length: 12 }, (_, i) => i);
        const gridBorderColor = `rgba(0, 0, 0, ${config.gridOpacity})`;
        
        const [isAnimOpen, setIsAnimOpen] = useState(false);

        return (
            <div className="flex flex-col w-full px-[8mm]">
                <HeaderSection 
                    char={char} 
                    paths={paths} 
                    loading={loading} 
                    failed={failed} 
                    config={config} 
                    dbData={dbData}
                />
            
                <div className="flex border-l border-t w-fit" style={{ borderColor: gridBorderColor }}>
                    {boxes.map((i) => (
                    <GridBox
                        key={i}
                        index={i}
                        char={char}
                        type={i === 0 ? 'reference' : 'trace'}
                        config={config}
                        svgData={fullSvg}
                        failed={failed}
                        onClick={i === 0 ? () => setIsAnimOpen(true) : undefined}
                    />
                    ))}
                </div>

                {/* Modal nhận thêm fullSvg và dbData */}
                <KanjiAnimationModal 
                    char={char}
                    paths={paths}
                    fullSvg={fullSvg}  // <-- Truyền chuỗi SVG gốc để lấy số
                    dbData={dbData}    // <-- Truyền data để lấy Âm/Nghĩa
                    isOpen={isAnimOpen}
                    onClose={() => setIsAnimOpen(false)}
                />
            </div>
        );
    };

      // 4. Page Layout (Đã cập nhật giao diện Bản Mẫu)
      const Page = ({ chars, config, dbData }) => {
        // Kiểm tra xem có phải đang ở chế độ bản mẫu (không có text) hay không
        const isSample = !config.text || config.text.trim().length === 0;

        return (
          <div className="a4-page mx-auto relative flex flex-col pt-[15mm] pl-[3mm] bg-white">
            
            {/* --- PHẦN TIÊU ĐỀ BẢN MẪU (CHỈ HIỆN KHI TRỐNG) --- */}
            {isSample && (
                <div className="w-full max-w-[210mm] mb-6 text-left pl-[8mm]">
                    <h2 className="text-xl font-black text-gray-600 uppercase mb-3 font-sans tracking-wide">
                        HƯỚNG DẪN
                    </h2>
                    <div className="text-sm text-gray-500 font-medium space-y-1.5 font-sans">
                        <p className="flex items-center gap-2">
                            <span className="bg-gray-100 text-gray-600 w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-bold">1</span>
                            Nhập dữ liệu để tạo file luyện viết.
                        </p>
                        <p className="flex items-center gap-2">
                            <span className="bg-gray-100 text-gray-600 w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-bold">2</span>
                            Ấn vào chữ mẫu đầu tiên để xem họa hoạt cách viết.
                        </p>
                        <p className="flex items-center gap-2">
                            <span className="bg-gray-100 text-gray-600 w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-bold">3</span>
                            Có thể xem âm On/Kun trong phần "tùy chỉnh".
                        </p>
                    </div>
                </div>
            )}

            {/* DANH SÁCH CÁC DÒNG */}
            <div className="flex flex-col gap-[4mm]">
              {chars.map((char, index) => (
                <WorkbookRow
                  key={`${index}-${char}`}
                  char={char}
                  config={config}
                  dbData={dbData}
                />
              ))}
            </div>

            {/* Branding Footer */}
            <div className="absolute bottom-[5mm] left-[12.5mm] text-gray-600 text-xs font-sans">
                {/* Dòng 1 */}
                <div className="text-[10px]">
                    © Bản quyền thuộc <span className="font-bold text-gray-700">Phá Đảo Tiếng Nhật</span> 
                    <span> (<span className="font-bold italic text-gray-700">phadaotiengnhat.com</span>)</span>
                </div>
                
                {/* Dòng 2 */}
                <div className="text-[10px] mt-0.5">
                    Tài liệu miễn phí - Nghiêm cấm mọi hành vi mua bán thương mại
                </div>
            </div>
          </div>
        );
      };

// 5. Sidebar (Phiên bản: Final)
      const Sidebar = ({ config, onChange, onPrint, isMenuOpen, setIsMenuOpen, isConfigOpen, setIsConfigOpen, isCafeModalOpen, setIsCafeModalOpen, showMobilePreview, setShowMobilePreview, dbData }) => {
        const scrollRef = useRef(null);
        const [searchResults, setSearchResults] = useState([]);
        const [activeIndex, setActiveIndex] = useState(0); 
        const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
        const [isDocsModalOpen, setIsDocsModalOpen] = useState(false);

        // --- CHẶN TUYỆT ĐỐI CTRL + P (KHÔNG CÓ GÌ XẢY RA) ---
      useEffect(() => {
        const handleKeyDown = (e) => {
          // Kiểm tra Ctrl + P (Win) hoặc Command + P (Mac)
          if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
            e.preventDefault(); // Chặn trình duyệt mở bảng in
            e.stopPropagation(); // Chặn sự kiện lan truyền
            return false; // Kết thúc ngay lập tức, không làm gì cả
          }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);
        
// --- CHẶN CUỘN TRANG KHI MỞ MODAL ---
useEffect(() => {
    // Nếu khung In hoặc khung Tài liệu đang mở
    if (isPrintModalOpen || isDocsModalOpen) {
        document.body.style.overflow = 'hidden'; // Khóa cuộn
    } else {
        document.body.style.overflow = 'unset';  // Mở lại cuộn bình thường
    }
    // Dọn dẹp khi tắt
    return () => { document.body.style.overflow = 'unset'; };
}, [isPrintModalOpen, isDocsModalOpen]);


        useEffect(() => {
    if (scrollRef.current) {
        const activeItem = scrollRef.current.childNodes[activeIndex];
        if (activeItem) {
            // Tự động cuộn đến mục đang chọn (block: 'nearest' để mượt hơn)
            activeItem.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }
    }
}, [activeIndex]); // Chạy lại mỗi khi activeIndex thay đổi

        // --- STATE QUẢN LÝ ---
        const [isLoading, setIsLoading] = useState(false);
        const [progress, setProgress] = useState(0);
        const [searchTerm, setSearchTerm] = useState('');

        // --- HÀM KIỂM TRA CẤP ĐỘ JLPT ---
const getJLPTLevel = (char) => {
    if (dbData.KANJI_LEVELS.N5.includes(char)) return 'N5';
    if (dbData.KANJI_LEVELS.N4.includes(char)) return 'N4';
    if (dbData.KANJI_LEVELS.N3.includes(char)) return 'N3';
    if (dbData.KANJI_LEVELS.N2.includes(char)) return 'N2';
    if (dbData.KANJI_LEVELS.N1.includes(char)) return 'N1';
    return null;
};

const levelColors = {
    N5: 'bg-green-100 text-green-700 border-green-200 hover:bg-green-600 hover:text-white hover:border-green-600',
    N4: 'bg-blue-100 text-blue-700 border-blue-200 hover:bg-blue-600 hover:text-white hover:border-blue-600',
    N3: 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-600 hover:text-white hover:border-orange-600',
    N2: 'bg-purple-100 text-purple-700 border-purple-200 hover:bg-purple-600 hover:text-white hover:border-purple-600',
    N1: 'bg-red-100 text-red-700 border-red-200 hover:bg-red-600 hover:text-white hover:border-red-600'
};

        
        // Menu Popup & Ref
        const [isUtilsOpen, setIsUtilsOpen] = useState(false);
        const [isFilterMenuOpen, setIsFilterMenuOpen] = useState(false);
        const filterRef = useRef(null);
        const quickMenuRef = useRef(null); // THÊM: Ref cho menu Chọn nhanh
        const utilsMenuRef = useRef(null); // THÊM: Ref cho menu Tiện ích
        const cafeModalRef = useRef(null);
        const searchInputRef = useRef(null); // Tạo "địa chỉ" cho ô nhập liệu
        const configMenuRef = useRef(null);
        // Biến kiểm soát bộ gõ IME (Quan trọng)
        const isComposing = useRef(false);

        const [randomCount, setRandomCount] = useState(10); 

        // State hiển thị nội bộ
        const [localText, setLocalText] = useState(config.text);

        // Tùy chọn bộ lọc
        const [filterOptions, setFilterOptions] = useState({
            hiragana: true,
            katakana: true,
            kanji: true,
            removeDuplicates: false 
        });

        // --- HÀM TẠO PLACEHOLDER ---
        const getDynamicPlaceholder = () => {
            const labels = [];
            if (filterOptions.kanji) labels.push("漢字");       
            if (filterOptions.hiragana) labels.push("ひらがな"); 
            if (filterOptions.katakana) labels.push("カタカナ"); 
            
            if (labels.length === 0) return "Vui lòng chọn ít nhất 1 loại chữ...";
            return labels.join(", ");
        };

        // --- 1. CLICK RA NGOÀI ĐỂ ĐÓNG MENU ---
       // --- XỬ LÝ CLICK RA NGOÀI ĐỂ ĐÓNG MENU ---
useEffect(() => {
    function handleClickOutside(event) {
        // 1. Xử lý Bộ lọc (Filter)
        if (filterRef.current && !filterRef.current.contains(event.target)) {
            setIsFilterMenuOpen(false);
        }

        // 2. Xử lý "Chọn nhanh" (Quick Select) - Tự đóng khi click ra ngoài
        if (isMenuOpen && quickMenuRef.current && !quickMenuRef.current.contains(event.target)) {
            setIsMenuOpen(false);
        }

        // 3. Xử lý "Tiện ích" (Utils) - Tự đóng khi click ra ngoài
        if (isUtilsOpen && utilsMenuRef.current && !utilsMenuRef.current.contains(event.target)) {
            setIsUtilsOpen(false);
        }
        if (isCafeModalOpen && cafeModalRef.current && !cafeModalRef.current.contains(event.target)) {
            setIsCafeModalOpen(false);
        }
        // 5. MỚI: Xử lý "Tùy chỉnh" - Tự đóng khi click ra ngoài
        if (isConfigOpen && configMenuRef.current && !configMenuRef.current.contains(event.target)) {
            setIsConfigOpen(false);
        }

    }

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
}, [isMenuOpen, isUtilsOpen, isFilterMenuOpen, isCafeModalOpen, isConfigOpen]); // Thêm dependencies để cập nhật trạng thái mới nhất

        // --- 2. ĐỒNG BỘ DỮ LIỆU TỪ NGOÀI ---
        useEffect(() => {
            const currentClean = localText ? localText.replace(/[a-zA-Z]/g, '') : '';
            if (currentClean !== config.text) {
                setLocalText(config.text);
            }
        // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [config.text]);

        const handleChange = (key, value) => {
          onChange({ ...config, [key]: value });
        };

        const shuffleString = (str) => {
            const arr = [...str];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr.join('');
        };

        // --- HÀM TRỢ GIÚP: REGEX ---
        const getAllowedRegexString = (options, allowLatin = false) => {
            let ranges = "\\s"; 
            if (allowLatin) ranges += "a-zA-Z"; // Latinh luôn được phép ở input

            if (options.hiragana) ranges += "\\u3040-\\u309F";
            if (options.katakana) ranges += "\\u30A0-\\u30FF";
            if (options.kanji)    ranges += "\\u4E00-\\u9FAF\\u3400-\\u4DBF\\u2E80-\\u2FDF\\uF900-\\uFAFF"; 
            return ranges;
        };
        // --- HÀM TRỢ GIÚP: XÓA TRÙNG LẶP ---
          const getUniqueChars = (str) => {
              return Array.from(new Set(str)).join('');
              };

        // --- 3. XỬ LÝ CHECKBOX ---
        const handleFilterChange = (key) => {
            const newOptions = { ...filterOptions, [key]: !filterOptions[key] };
            setFilterOptions(newOptions);
            
            let newText = localText;

            // Xử lý các ô Hiragana/Katakana/Kanji (như cũ)
            if (['hiragana', 'katakana', 'kanji'].includes(key) && filterOptions[key] === true) {
                const allowedString = getAllowedRegexString(newOptions, true); 
                const regex = new RegExp(`[^${allowedString}]`, 'g');
                newText = newText.replace(regex, '');
            }

            // Xử lý ô Xóa trùng lặp (MỚI)
            if (newOptions.removeDuplicates) {
                newText = getUniqueChars(newText);
            }
            
            setLocalText(newText);
            handleChange('text', newText.replace(/[a-zA-Z]/g, ''));
        };

// --- 4. NÚT XÓA LATINH + DỒN DÒNG (PHIÊN BẢN XÓA SẠCH SÀNH SANH) ---
        const handleRemoveLatinManual = () => {
            if (!localText) return;
            let cleaned = localText;
            
            // 1. Xóa chữ cái Latinh
            cleaned = cleaned.replace(/[a-zA-Z]/g, '');
            
            // 2. Xóa hết dấu xuống dòng (Enter) -> Thay bằng rỗng ''
            cleaned = cleaned.replace(/[\n\r]+/g, '');
            
            // 3. Xóa hết các loại dấu cách (thường, tab, Nhật) -> Thay bằng rỗng ''
            // Regex này bao gồm: dấu cách thường ( ), dấu cách Nhật (　), và tab (\t)
            cleaned = cleaned.replace(/[ 　\t]+/g, ''); 
            
            // Cắt khoảng trắng thừa 2 đầu (nếu còn sót)
            cleaned = cleaned.trim();

            setLocalText(cleaned);
            handleChange('text', cleaned); 
        };

        // --- 5. XỬ LÝ NHẬP LIỆU (ĐÃ FIX LỖI IME) ---
      // --- 5. XỬ LÝ NHẬP LIỆU (REAL-TIME FILTER) ---
        const handleInputText = (e) => {
            const rawInput = e.target.value;

            // Nếu đang lơ lửng gõ bộ gõ (IME) thì cứ để hiện
            if (isComposing.current) {
                setLocalText(rawInput);
                return;
            }
            
            // 1. Lọc ký tự rác (số, icon...)
            const allowedString = getAllowedRegexString(filterOptions, true);
            const blockRegex = new RegExp(`[^${allowedString}]`, 'g');
            let validForInput = rawInput.replace(blockRegex, '');

            // 2. LOGIC QUAN TRỌNG: Lọc trùng ngay lập tức
            if (filterOptions.removeDuplicates) {
                validForInput = getUniqueChars(validForInput);
            }

            setLocalText(validForInput);
            handleChange('text', validForInput.replace(/[a-zA-Z]/g, ''));
        };

        const handleCompositionStart = () => {
            isComposing.current = true;
        };

        const handleCompositionEnd = (e) => {
            isComposing.current = false;
            
            // Lấy toàn bộ nội dung trong ô nhập lúc này
            const rawInput = e.target.value;
            
            // 1. Lọc rác
            const allowedString = getAllowedRegexString(filterOptions, true);
            const blockRegex = new RegExp(`[^${allowedString}]`, 'g');
            let validForInput = rawInput.replace(blockRegex, '');

            // 2. LOGIC QUAN TRỌNG: Lọc trùng ngay khi chốt chữ
            if (filterOptions.removeDuplicates) {
                validForInput = getUniqueChars(validForInput);
            }

            setLocalText(validForInput);
            handleChange('text', validForInput.replace(/[a-zA-Z]/g, ''));
        };
// Thêm tham số type (mặc định là 'kanji')
const handleLoadFromGithub = async (url, type = 'kanji') => {
    setProgress(0);
    setIsLoading(true);     
    setIsMenuOpen(false);   
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Lỗi tải dữ liệu từ ${url}`);
        }

        const rawText = await response.text();
        const cleanText = rawText.replace(/["\n\r\s,\[\]]/g, '');

        if (!cleanText) {
             alert("File dữ liệu rỗng!");
             setIsLoading(false);
             return;
        }

      
        setFilterOptions(prev => ({ ...prev, [type]: true })); 
        
        setProgress(30);
        setTimeout(() => setProgress(100), 300);

        setTimeout(() => {
            setLocalText(cleanText);              
            onChange({ ...config, text: cleanText }); 
            setIsLoading(false);                  
        }, 500);

    } catch (error) {
        console.error("Lỗi:", error);
        alert("Không tải được dữ liệu. Vui lòng kiểm tra lại đường truyền hoặc link GitHub.");
        setIsLoading(false);
    }
};
        // --- HÀM MỚI: Lấy ngẫu nhiên Kanji từ GitHub ---
        const handleRandomLoadFromGithub = async (level) => {
            // 1. Kiểm tra số lượng
            if (randomCount === '' || randomCount <= 0) {
                alert("Vui lòng nhập số lượng chữ cần lấy!");
                return;
            }
            setProgress(0);

            // 2. Tạo link file: kanjin5.json...
            const fileName = `kanji${level.toLowerCase()}.json`; 
            const url = `https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/${fileName}`;

            setIsLoading(true);
            setIsUtilsOpen(false); // Đóng menu Tiện ích
            
            try {
                // 3. Tải file về
                const response = await fetch(url);
                if (!response.ok) throw new Error("Lỗi tải file");
                
                const rawText = await response.text();
                const cleanText = rawText.replace(/["\n\r\s]/g, '');

                if (!cleanText) {
                     alert("File dữ liệu rỗng!");
                     setIsLoading(false);
                     return;
                }

                // 4. Xáo trộn và cắt lấy số lượng cần thiết
                const shuffled = shuffleString(cleanText); // Hàm shuffleString có sẵn trong code cũ rồi
                let count = randomCount > 50 ? 50 : randomCount;
                const selectedChars = shuffled.slice(0, count);

                // 5. Hiển thị
                setFilterOptions(prev => ({ ...prev, kanji: true }));
                
                setProgress(30);
                setTimeout(() => setProgress(100), 300);

                setTimeout(() => {
                    setLocalText(selectedChars);
                    onChange({ ...config, text: selectedChars });
                    setIsLoading(false);
                }, 500);

            } catch (error) {
                console.error(error);
                alert(`Không tải được dữ liệu ${level}. Kiểm tra lại mạng hoặc link GitHub.`);
                setIsLoading(false);
            }
        };
        // --- 6. XỬ LÝ RỜI TAY ---
        const handleBlurText = () => {
            if (!localText) return;
            let cleaned = localText; 
            cleaned = cleaned.replace(/[ \t]+/g, ' '); 
            cleaned = cleaned.replace(/(\n\s*){2,}/g, '\n'); 
            cleaned = cleaned.trim();

            if (filterOptions.removeDuplicates) {
                cleaned = getUniqueChars(cleaned);
            }

            if (cleaned !== localText) {
                setLocalText(cleaned);
                handleChange('text', cleaned.replace(/[a-zA-Z]/g, ''));
            }
        };

        // --- CÁC HÀM TIỆN ÍCH KHÁC ---
        const handleSmartLoad = (content, type = null) => {
            if (!content) return;
            setIsLoading(true); setIsMenuOpen(false); setIsUtilsOpen(false); setIsConfigOpen(false); setProgress(0);
            
            if (type) setFilterOptions(prev => ({ ...prev, [type]: true }));
            else if (type === 'all') setFilterOptions(prev => ({ ...prev, kanji: true }));

            const interval = setInterval(() => {
                setProgress((prev) => { if (prev >= 90) return 90; return prev + Math.floor(Math.random() * 10) + 5; });
            }, 80);
            setTimeout(() => {
                setLocalText(content);
                onChange({ ...config, text: content });
                clearInterval(interval); setProgress(100); setTimeout(() => setIsLoading(false), 200);
            }, 600);
        };


        const handleShuffleCurrent = () => {
            if (!config.text) { alert("Chưa có nội dung!"); return; }
            handleSmartLoad(shuffleString(config.text));
        };

        // Hàm xử lý tìm kiếm thời gian thực
 const handleSearchRealtime = (val) => {
    setSearchTerm(val);
    const query = val.toLowerCase().trim();
    const queryNoAccent = removeAccents(query);
    
    if (!query) {
        setSearchResults([]);
        return;
    }

    const matches = [];
    const processData = (source, type) => {
        Object.entries(source).forEach(([char, info]) => {
            if (info.sound) {
                const sound = info.sound.toLowerCase();
                const soundNoAccent = removeAccents(sound);

                // Tính toán trọng số ưu tiên (Càng thấp càng đứng đầu)
                let priority = 99;

                if (sound === query) priority = 1; // 1. Khớp chính xác (An -> AN)
                else if (soundNoAccent === queryNoAccent) priority = 2; // 2. Khớp chính xác không dấu (An -> ÁN)
                else if (sound.includes(query)) priority = 3; // 3. Chứa vần chính xác (An -> SAN)
                else if (soundNoAccent.includes(queryNoAccent)) priority = 4; // 4. Chứa vần không dấu (An -> HÁN)

                if (priority < 99) {
                    matches.push({ char, ...info, type, priority, sound });
                }
            }
        });
    };

    processData(dbData.KANJI_DB, 'kanji');

    // Sắp xếp theo trọng số, nếu cùng trọng số thì xếp theo Alphabet
    matches.sort((a, b) => {
        if (a.priority !== b.priority) return a.priority - b.priority;
        return a.sound.localeCompare(b.sound);
    });

    setSearchResults(matches.slice(0, 20));
    setActiveIndex(0); // Reset về vị trí đầu tiên
};

       // --- HÀM CHỌN CHỮ TỪ GỢI Ý (ĐÃ FIX LỖI TRÙNG LẶP) ---
const selectResult = (item) => {
    // 1. Tạo chuỗi mới bằng cách cộng chữ vừa chọn vào cuối
    let newText = config.text + item.char;

    // 2. KIỂM TRA: Nếu đang bật tính năng "Xóa trùng lặp" thì lọc chuỗi ngay
    if (filterOptions.removeDuplicates) {
        newText = getUniqueChars(newText);
    }

    // 3. Cập nhật vào giao diện và dữ liệu hệ thống
    setLocalText(newText);
    handleChange('text', newText);
    
    // 4. Reset ô tìm kiếm
    setSearchTerm('');
    setSearchResults([]);
    setActiveIndex(0);
    
    // 5. Tự động bật bộ lọc tương ứng 
    if (item.type === 'kanji') setFilterOptions(p => ({...p, kanji: true}));
    else if (item.char.match(/[\u3040-\u309F]/)) setFilterOptions(p => ({...p, hiragana: true}));
    else setFilterOptions(p => ({...p, katakana: true}));
};
        
        const toggleMenu = (menuName) => {
            setIsCafeModalOpen(false); 
            setIsFilterMenuOpen(false); 
            if (menuName === 'quick') { setIsMenuOpen(!isMenuOpen); setIsUtilsOpen(false); setIsConfigOpen(false); }
            else if (menuName === 'utils') { setIsUtilsOpen(!isUtilsOpen); setIsMenuOpen(false); setIsConfigOpen(false); }
            else if (menuName === 'config') { setIsConfigOpen(!isConfigOpen); setIsMenuOpen(false); setIsUtilsOpen(false); }
        };

        // Check warning để đổi font placeholder
        const isWarningMode = !filterOptions.hiragana && !filterOptions.katakana && !filterOptions.kanji;

        return (
          <div className="w-full md:w-96 bg-white shadow-xl p-6 flex flex-col gap-6 h-auto md:h-screen md:overflow-y-auto relative md:sticky top-0 border-r border-gray-200 z-50 hide-scrollbar">
            
           {/* HEADER */}
            <div className="mb-4 pb-3 border-b border-gray-100"> 
              <h1 className="text-xl font-bold text-gray-800 flex items-center gap-1.5 mb-1">
                <span className="text-2xl leading-none -mt-1">⛩️</span>
                TẠO FILE LUYỆN VIẾT KANJI
              </h1>
            </div>

            <div className="space-y-6 flex-1">
                
            {/* TÌM KIẾM THÔNG MINH (BƯỚC 3) */}
<div className="space-y-1.5 pb-2 mb-2 relative">
    <div className="flex gap-2">
<div className="relative flex-1">
    {/* Icon Kính lúp (Bên trái) */}
    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-500">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
        </svg>
    </div>
    
    {/* Ô Input */}
    <input 
        ref={searchInputRef}
        type="text" 
        value={searchTerm} 
        className="w-full pl-10 pr-10 py-2.5 border border-indigo-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-indigo-50 text-indigo-900 placeholder-indigo-400 font-bold font-sans" 
        placeholder="Tìm Kanji theo âm Hán Việt" 
        onChange={(e) => handleSearchRealtime(e.target.value)} 
        onKeyDown={(e) => {
            if (searchResults.length > 0) {
                if (e.key === 'ArrowDown') { 
                    e.preventDefault(); 
                    setActiveIndex(prev => (prev < searchResults.length - 1 ? prev + 1 : 0)); 
                } else if (e.key === 'ArrowUp') { 
                    e.preventDefault(); 
                    setActiveIndex(prev => (prev > 0 ? prev - 1 : searchResults.length - 1)); 
                } else if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    selectResult(searchResults[activeIndex]); 
                }
            }
        }}
    />

    {/* NÚT X ĐỂ XÓA (MỚI THÊM) - Chỉ hiện khi đang có chữ */}
    {searchTerm && (
        <button 
            onClick={() => {
                setSearchTerm('');    // Xóa chữ
                setSearchResults([]); // Đóng danh sách gợi ý
                searchInputRef.current.focus();
            }}
            className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-indigo-600 transition-colors"
            title="Xóa tìm kiếm"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    )}
</div>
    </div>

    {/* DROPDOWN KẾT QUẢ GỢI Ý - CHỈ HIỆN KHI CÓ KẾT QUẢ */}
    {searchResults.length > 0 && (
        <div 
        ref={scrollRef}
        className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[70] max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in zoom-in-95 duration-200">
{searchResults.map((item, idx) => {
    const level = getJLPTLevel(item.char); // Kiểm tra cấp độ N1-N5

    return (
        <div 
            key={idx} 
            onClick={() => selectResult(item)}
            className={`flex items-center gap-3 p-3 cursor-pointer border-b border-gray-50 last:border-none transition-colors group ${
                idx === activeIndex ? 'bg-indigo-100' : 'bg-white hover:bg-indigo-50'
            }`}
        >
            {/* Chữ hiển thị */}
            <span className="text-2xl font-['Klee_One'] text-black group-hover:scale-110 transition-transform">
                {item.char}
            </span>

            {/* Âm Hán và nghĩa */}
            <div className="flex flex-col">
                <span className="text-[11px] font-black text-indigo-600 uppercase leading-tight">
                    {item.sound}
                </span>
                {item.meaning && (
                    <span className="text-[10px] text-gray-400 font-medium leading-tight">
                        {item.meaning}
                    </span>
                )}
            </div>

            {/* NHÃN MÁC (Badge) */}
            <div className="ml-auto">
                {level ? (
                    /* Nếu thuộc danh sách Kanji N1-N5 */
                    <div className={`px-1.5 py-0.5 rounded text-[9px] font-black border transition-all duration-200 ${levelColors[level]}`}>
                        {level}
                    </div>
                ) : (
                    /* Nếu KHÔNG thuộc N1-N5 -> Mặc định hiện mác BỘ THỦ */
                    <div className="px-1.5 py-0.5 rounded text-[9px] font-black border bg-gray-100 text-gray-500 border-gray-200 uppercase transition-all duration-200 hover:bg-gray-500 hover:text-white hover:border-gray-500 cursor-default">
                        Bộ thủ
                    </div>
                )}
            </div>
        </div>
    );
})}
        </div>
    )}

</div>

                {/* KHUNG NHẬP LIỆU */}
                <div className="space-y-2 pt-2">
                  {/* --- TIÊU ĐỀ & CÁC NÚT (ĐÃ CHỈNH SỬA GIAO DIỆN) --- */}
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-sm font-medium text-gray-700 font-sans">Nhập dữ liệu</label>
                    
                    {/* CỤM NÚT BỘ LỌC VÀ XÓA */}
                    <div className="flex items-center gap-3 relative">
                        
                        {/* 1. NÚT MỞ BỘ LỌC */}
                        <div className="relative" ref={filterRef}>
                            <button 
                                onClick={() => setIsFilterMenuOpen(!isFilterMenuOpen)}
                                className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1 rounded transition-colors ${isFilterMenuOpen ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50 hover:text-indigo-700'}`}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                                Bộ lọc
                            </button>

                            {/* POPUP MENU BỘ LỌC */}
                            {isFilterMenuOpen && (
                                <div className="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-2xl p-3 z-50 animate-in fade-in zoom-in-95 duration-200">
                                    <div className="flex items-center justify-between mb-2 pb-2 border-b border-gray-100">
                                        <span className="text-[10px] font-bold text-gray-500 uppercase">BỘ LỌC</span>
                                        <div className="group relative cursor-help">
                                            <div className="text-gray-400 hover:text-indigo-500 border border-gray-300 rounded-full w-3.5 h-3.5 flex items-center justify-center text-[9px] font-serif font-bold bg-gray-50">i</div>
                                            {/* Tooltip chữ i */}
                                            <div className="absolute right-0 bottom-full mb-2 w-48 p-2 bg-gray-900 text-white text-[9px] rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg z-[60]">
                                                1. Bỏ tích ô nào, chữ loại đó sẽ bị xóa ngay lập tức khỏi ô nhập liệu. <br/>
                                                2. "LÀM SẠCH" sẽ xóa hết chữ latinh, khoảng trắng thừa trong ô nhập liệu.
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-2.5">
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.kanji} onChange={() => handleFilterChange('kanji')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Kanji & Bộ thủ
                                        </label>
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.hiragana} onChange={() => handleFilterChange('hiragana')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Hiragana
                                        </label>
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.katakana} onChange={() => handleFilterChange('katakana')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Katakana
                                        </label>
                                        {/* ĐƯỜNG KẺ MỜ NGĂN CÁCH (MỚI) */}
                                        <hr className="border-gray-100 my-1"/>

    {/* TÙY CHỌN: XÓA TRÙNG LẶP (ĐỔI MÀU ĐỘNG) */}
<label className={`flex items-center gap-2 text-xs cursor-pointer select-none transition-colors ${
    filterOptions.removeDuplicates 
        ? 'text-red-500 hover:text-red-600'  // Khi ĐANG TÍCH: Màu đỏ đậm
        : 'text-gray-700 hover:text-indigo-600'        // Khi KHÔNG TÍCH: Màu xám bình thường
}`}>
    <input 
        type="checkbox" 
        checked={filterOptions.removeDuplicates} 
        onChange={() => handleFilterChange('removeDuplicates')} 
        className={`w-3.5 h-3.5 rounded-sm ${
            filterOptions.removeDuplicates ? 'accent-red-500' : 'accent-indigo-500'
        }`}
    />
    Xóa chữ trùng lặp
</label>
                                        
                                        <hr className="border-gray-100"/>
                                        
 {/* NÚT LÀM SẠCH  */}
<button 
    onClick={handleRemoveLatinManual} 
    className="w-full py-2 text-xs font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg flex items-center justify-center gap-1 transition">
    LÀM SẠCH
</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* 2. NÚT XÓA TẤT CẢ */}
                        <button onClick={() => { setLocalText(''); handleChange('text', ''); }} className="flex items-center gap-1 text-[10px] font-bold text-red-500 hover:text-red-700 transition-colors uppercase tracking-tighter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg> XÓA TẤT CẢ
                        </button>
                    </div>
                  </div>
                   <textarea 
                    className={`w-full h-[104px] p-3 pr-1 border border-gray-300 rounded-lg resize-none text-lg bg-white text-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-inner input-scrollbar ${(isWarningMode && !localText) ? 'font-sans' : "font-['Klee_One']"}`}
                    placeholder={getDynamicPlaceholder()} 
                    value={localText} 
                    onChange={handleInputText} 
                    onCompositionStart={handleCompositionStart}
                    onCompositionEnd={handleCompositionEnd}
                    onBlur={handleBlurText}    
                   />
                </div>
                
                {/* --- FOOTER CHỨC NĂNG --- */}
                <div className="flex flex-col gap-3 w-full">
                  
                  {/* HÀNG 3 NÚT */}
                  <div className="flex flex-row gap-4 w-full h-12">
                      
                      {/* 1. CHỌN NHANH */}
                      <div className="relative flex-1" ref={quickMenuRef}> 
                        <button onClick={() => toggleMenu('quick')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isMenuOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">Chọn nhanh</span>
                        </button>
                        {isMenuOpen && (
                          <div className="absolute bottom-full left-0 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-4 animate-in fade-in zoom-in-95 duration-200">
                            <div>
                              <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">Bảng chữ cái</p>
 <div className="grid grid-cols-2 gap-2">
  <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/hiragana.json', 'hiragana')} 
    className="py-2 text-xs font-bold bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-black hover:text-white transition"
  >
    あ Hiragana
  </button>
  
  <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/katakana.json', 'katakana')} 
    className="py-2 text-xs font-bold bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-black hover:text-white transition"
  >
    ア Katakana
  </button>
</div>
                            </div>
    <div>
    <p className="text-[10px] font-bold text-gray-400 uppercase mb-2">Bộ thủ</p>
    <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/bothu.json')} 
    className="w-full py-2 text-xs font-black border bg-gray-100 text-gray-500 border-gray-200 uppercase transition-all duration-200 hover:bg-gray-500 hover:text-white hover:border-gray-500 rounded"
>
    Bộ thủ cơ bản
</button>
</div>
                            <div>
                              <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">Lấy tất cả Kanji</p>
                              <div className="grid grid-cols-5 gap-1.5">
 {['N5', 'N4', 'N3', 'N2', 'N1'].map((level) => (
  <button 
    key={level} 
    onClick={() => {
        // Tạo link: kanjin5.json, kanjin4.json...
        const fileName = `kanji${level.toLowerCase()}.json`; 
        const url = `https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/${fileName}`;
        handleLoadFromGithub(url);
    }} 
    className={`py-2 text-[11px] font-black border rounded-md transition-all duration-200 active:scale-95 ${levelColors[level]}`}
  >
    {level}
  </button>
))}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* 2. TIỆN ÍCH */}
                      <div className="relative flex-1" ref={utilsMenuRef}> 
                        <button onClick={() => toggleMenu('utils')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isUtilsOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">Tiện ích</span>
                        </button>
                        
                        {isUtilsOpen && (
                          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-5 animate-in fade-in zoom-in-95 duration-200">
                            
                            {/* Xáo trộn */}
                            <div>
                                <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">Công cụ</p>
                                <button onClick={handleShuffleCurrent} className="w-full py-2.5 text-xs font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-lg hover:bg-indigo-600 hover:text-white transition flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                    Xáo trộn danh sách hiện tại
                                </button>
                            </div>

                            {/* Lấy ngẫu nhiên */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <p className="text-[10px] font-bold text-gray-400 uppercase">Lấy ngẫu nhiên</p>
                                    {/* CỤM INPUT MÀU CAM */}
                                    <div className="flex items-center gap-1.5">
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="50"
                                            value={randomCount}
                                            onChange={(e) => {
                                                const val = e.target.value;
                                                if (val === '') setRandomCount('');
                                                else setRandomCount(parseInt(val));
                                            }}
                                            onKeyDown={(e) => { if(e.key==='Enter' && randomCount>50) setRandomCount(50) }}
                                            onBlur={() => { if(randomCount>50) setRandomCount(50) }}
                                            className="w-14 h-7 text-xs text-center font-bold bg-white border border-gray-300 text-gray-700 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors"
                                        />
                                        <span className="text-[10px] font-bold text-gray-500">chữ</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-5 gap-1.5">
                                   {['N5', 'N4', 'N3', 'N2', 'N1'].map((level) => (
  <button 
    key={level} 
    onClick={() => handleRandomLoadFromGithub(level)} 
    className={`py-2 text-[11px] font-black border rounded-md transition-all duration-200 ${levelColors[level]}`}
  >
    {level}
  </button>
))}
                                </div>
                            </div>
                            {/* Phần Quizlet nằm ở cuối cùng */}
    <div className="pt-4 border-t border-gray-100">
        <div className="flex items-center gap-2 mb-2">
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-tight">ÔN TẬP</p>
            <span className="flex-1 border-b border-gray-50"></span>
        </div>
        <a 
            href="https://quizlet.com/join/mE5CzMyT7?i=4yxqkk&x=1bqt" 
            target="_blank" 
            className="w-full py-3 bg-[#4255ff] hover:bg-[#3243cc] text-white rounded-xl flex items-center justify-center gap-2 shadow-md transition-all active:scale-95 group"
        >
            <span className="bg-white p-0.5 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4255ff" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </span>
            <span className="text-xs font-black tracking-wide">FLASHCARD KANJI</span>
        </a>
    </div>
                          </div>
                        )}
                      </div>

                      {/* 3. TÙY CHỈNH */}
                      <div className="relative flex-1" ref={configMenuRef}> 
                        <button onClick={() => toggleMenu('config')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isConfigOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">Tùy chỉnh</span>
                        </button>
                        
{isConfigOpen && (
    <div className="absolute bottom-full right-0 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-3.5 animate-in fade-in zoom-in-95 duration-200">

        {/* MỤC 1: SỐ CHỮ MẪU */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">Số chữ mẫu</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{config.traceCount} chữ</span>
            </div>
            <input type="range" min="0" max="12" step="1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.traceCount} onChange={(e) => handleChange('traceCount', parseInt(e.target.value))} />
        </div>

        {/* MỤC 2: ĐỘ ĐẬM CHỮ */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">Độ đậm chữ</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{Math.round(config.traceOpacity * 100)}%</span>
            </div>
            <input type="range" min="0.05" max="0.5" step="0.05" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.traceOpacity} onChange={(e) => handleChange('traceOpacity', parseFloat(e.target.value))} />
        </div>

        {/* MỤC 3: CỠ CHỮ */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">Cỡ chữ</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{config.fontSize} pt</span>
            </div>
            <input type="range" min="30" max="40" step="1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.fontSize} onChange={(e) => handleChange('fontSize', parseInt(e.target.value))} />
        </div>

        {/* MỤC 4: ĐỘ ĐẬM KHUNG */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">Độ đậm khung</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{Math.round(config.gridOpacity * 100)}%</span>
            </div>
            <input type="range" min="0.1" max="1" step="0.1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.gridOpacity} onChange={(e) => handleChange('gridOpacity', parseFloat(e.target.value))} />
        </div>

       {/* MỤC 5: NÚT GẠT ON/KUN (LUÔN BẬT/TẮT ĐƯỢC) */}
<div className="pt-2 border-t border-gray-100">
    <div className="space-y-1">
        {/* Đã bỏ hasJLPT ? 'cursor-pointer' : 'cursor-not-allowed opacity-50' */}
        <label className="flex items-center justify-between group cursor-pointer">
            <span className="text-[11px] font-bold text-gray-600">Hiện âm On/Kun</span>
            <div className="relative inline-block w-9 h-5">
                <input 
                    type="checkbox" 
                    className="peer opacity-0 w-0 h-0" 
                    checked={config.showOnKun} // Chỉ phụ thuộc vào config
                    onChange={() => handleChange('showOnKun', !config.showOnKun)} // Luôn cho phép bấm
                />
                {/* Màu sắc luôn sáng rõ để người dùng biết là bấm được */}
                <span className="absolute inset-0 rounded-full transition-all duration-300 bg-gray-200 peer-checked:bg-indigo-600"></span>
                <span className={`absolute left-1 bottom-1 w-3 h-3 rounded-full bg-white transition-all duration-300 ${config.showOnKun ? 'translate-x-4' : ''}`}></span>
            </div>
        </label>
    </div>
</div>

{/* NÚT ĐẶT LẠI MẶC ĐỊNH - Đã thu gọn */}
<div className="pt-0"> {/* Giảm padding top từ pt-1 về pt-0 */}
    <button 
        onClick={() => onChange({ ...config, fontSize: 35, traceCount: 9, traceOpacity: 0.15, gridOpacity: 0.8, showOnKun: false })} 
        className="w-full py-1.5 text-[10px] font-bold text-red-500 bg-red-50 hover:bg-red-500 hover:text-white rounded-lg flex items-center justify-center gap-1 transition-all active:scale-95"
    >
        {/* Giảm size icon từ 12 xuống 10 */}
        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> 
        KHÔI PHỤC MẶC ĐỊNH
    </button>
</div>

    </div>
)}
                      </div>
                  </div>

{/* --- PHẦN CUỐI CỦA SIDEBAR (CẬP NHẬT THÊM NÚT TÀI LIỆU) --- */}
      <div className="w-full mt-auto pt-4 flex flex-col gap-4"> 
        
        {/* 1. NÚT IN (ĐÃ SỬA: CHẶN KHI RỖNG) */}
        <button 
          onClick={() => {
            // --- LOGIC KIỂM TRA MỚI ---
            if (!config.text || config.text.trim().length === 0) {
                alert("Vui lòng nhập nội dung để tạo file"); 
                return; // Dừng lại, không mở modal in
            }
            setIsPrintModalOpen(true); 
          }} 
          className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transition-all active:scale-95 group"
        >
          <svg className="w-5 h-5 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
          IN / LƯU PDF
        </button>

{/* --- 2. NÚT XEM TRƯỚC / XEM BẢN MẪU (MÀU: XANH KHI XEM, ĐỎ KHI ĐÓNG) --- */}
{(() => {
    // Biến kiểm tra xem có nội dung hay không
    const isEmpty = !config.text || config.text.trim().length === 0;

    return (
        <button 
            onClick={() => {
                if (showMobilePreview) {
                    setShowMobilePreview(false);
                } else {
                    setShowMobilePreview(true);
                    // Cuộn xuống vùng xem trước
                    setTimeout(() => {
                        const previewElement = document.getElementById('preview-area');
                        if(previewElement) previewElement.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }
            }}
            className={`md:hidden w-full py-3 font-bold rounded-xl border shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-all mt-3 ${
                showMobilePreview 
                    ? 'bg-red-50 text-red-700 border-red-200'      // KHI ĐANG MỞ -> MÀU ĐỎ
                    : 'bg-green-50 text-green-700 border-green-200' // KHI ĐANG ĐÓNG -> MÀU XANH
            }`}
        >
            {showMobilePreview ? (
                // === TRẠNG THÁI: ĐANG MỞ (NÚT ĐỂ ĐÓNG LẠI) ===
                <>
                    {isEmpty ? (
                        // Đóng bản mẫu: Giữ nguyên icon X
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    ) : (
                        // Đóng bản in: Dùng icon CON MẮT MỞ (Eye)
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    )}

                    {isEmpty ? "ĐÓNG HƯỚNG DẪN" : "ĐÓNG BẢN XEM TRƯỚC"}
                </>
            ) : (
                // === TRẠNG THÁI: ĐANG ĐÓNG (NÚT ĐỂ MỞ RA) ===
                <>
                    {isEmpty ? (
                        /* Xem bản mẫu: Giữ nguyên icon Quyển sách */
                        <>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                            XEM HƯỚNG DẪN
                        </>
                    ) : (
                        /* Xem trước bản in: Dùng icon CON MẮT GẠCH CHÉO (Eye Off) */
                        <>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                            XEM TRƯỚC BẢN IN
                        </>
                    )}
                </>
            )}
        </button>
    );
})()}

        {/* 2. KHU VỰC LIÊN HỆ (4 NÚT: DONATE - TIKTOK - NHÓM - TÀI LIỆU) */}
        <div className="flex items-center justify-between px-2 gap-2 text-xs font-bold text-gray-500 pb-2">
            
 {/* Nút Donate */}
            <div className="relative flex flex-col items-center" ref={cafeModalRef}>
                <button 
                    onClick={() => { setIsCafeModalOpen(!isCafeModalOpen); setIsMenuOpen(false); setIsUtilsOpen(false); setIsConfigOpen(false); setIsFilterMenuOpen(false); }} 
                    className="flex flex-col items-center gap-1 group w-full"
                >
                    {/* Icon Container: Cố định w-9 h-9 để tròn đều */}
                    <div className="p-2 bg-orange-50 rounded-full text-orange-500 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
                            <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
                            <line x1="6" y1="2" x2="6" y2="4"/>
                            <line x1="10" y1="2" x2="10" y2="4"/>
                            <line x1="14" y1="2" x2="14" y2="4"/>
                        </svg>
                    </div>
                    <span className="text-[10px] font-bold text-gray-500 group-hover:text-orange-600">Mời cafe</span>
                </button>

                {/* Popup Cafe */}
                {isCafeModalOpen && (
                    <div className="absolute bottom-full left-0 mb-3 z-[60] w-60 bg-white border border-orange-100 rounded-2xl p-4 shadow-2xl animate-in fade-in slide-in-from-bottom-2 duration-200">
                        <div className="text-center space-y-3">
                            <p className="text-[10px] text-orange-800 font-medium leading-tight">Sự ủng hộ của bạn giúp mình duy trì và phát triển nhiều tính năng mới. Cảm ơn bạn rất nhiều!</p>
                            <div className="bg-gray-50 p-2 rounded-lg inline-block shadow-inner">
                                <img src="https://i.ibb.co/JWGwcTL1/3381513652021492183.jpg" alt="QR Cafe" className="w-28 h-auto rounded"/>
                            </div>
                            <p className="text-[11px] text-orange-500 font-bold bg-orange-50 py-1 rounded">MB BANK: 99931082002</p>
                        </div>
                        {/* Mũi tên trỏ xuống của popup */}
                        <div className="absolute top-full left-4 -mt-1 w-3 h-3 bg-white border-b border-r border-orange-100 rotate-45"></div>
                    </div>
                )}
            </div>
            {/* Nút Tiktok */}
            <a href="https://www.tiktok.com/@phadaotiengnhat" target="_blank" rel="noopener noreferrer" className="flex flex-col items-center gap-1 hover:text-black transition-colors group">
                <div className="p-2 bg-gray-100 rounded-full text-gray-600 group-hover:bg-black group-hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"/></svg>
                </div>
                <span className="text-[10px]">Tiktok</span>
            </a>

            {/* Nút Nhóm */}
            <a href="https://zalo.me/g/ujgais332" target="_blank" rel="noopener noreferrer" className="flex flex-col items-center gap-1 hover:text-blue-600 transition-colors group">
                <div className="p-2 bg-blue-50 rounded-full text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
                <span className="text-[10px]">Nhóm</span>
            </a>

            {/* --- NÚT MỚI: TÀI LIỆU --- */}
            <button 
                onClick={() => setIsDocsModalOpen(true)}
                className="flex flex-col items-center gap-1 hover:text-purple-600 transition-colors group"
            >
                <div className="p-2 bg-purple-50 rounded-full text-purple-500 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </div>
                <span className="text-[10px]">Tài liệu</span>
            </button>

        </div>

      </div>

      {/* --- POPUP TÀI LIỆU (MỚI THÊM) --- */}
      {isDocsModalOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200 border border-gray-200 flex flex-col max-h-[80vh]">
                
                {/* Header của Popup */}
                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 className="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
    {/* Bắt đầu Icon 2D */}
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
    </svg>
    {/* Kết thúc Icon 2D */}
    TÀI LIỆU HỌC TẬP
</h3>
                    <button onClick={() => setIsDocsModalOpen(false)} className="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                {/* Danh sách tài liệu (Cuộn được nếu dài) */}
                <div className="p-4 space-y-3 overflow-y-auto custom-scrollbar">
                    
                    {/* 2139 kanji */}
                    <a href="https://drive.google.com/file/d/1Q3bbd3Aao7R71wemjESHddbvmXWYe542/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">2139 Hán tự (N5-N1)</p>
                            <p className="text-[10px] text-gray-400">PDF • 797 KB</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                   {/* quy tắc chuyển âm */}
                    <a href="https://drive.google.com/file/d/17L2ufF9P0GfLrhzE_yCsAqjXYSYrhTxU/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Quy tắc chuyển âm</p>
                            <p className="text-[10px] text-gray-400">PDF • 128 KB</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                    {/* Flashcard Kanji */}
                    <a href="https://quizlet.com/join/mE5CzMyT7?i=4yxqkk&x=1bqt" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Flashcard 2139 kanji N5-N1</p>
                            <p className="text-[10px] text-gray-400">147 học phần</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                    {/* Flashcard từ vựng */}
                    <a href="https://quizlet.com/join/nuE9y8xHf?i=4yxqkk&x=1bqt" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Flashcard từ vựng N5-N1</p>
                            <p className="text-[10px] text-gray-400">354 học phần</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                  {/* nhóm học tập */}
                    <a href="https://zalo.me/g/ujgais332" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        {/* Đã đổi: bg-blue -> bg-orange */}
                        <div className="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            {/* Đã đổi: Icon File -> Icon Nhóm người */}
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Thêm nhiều tài liệu khác...</p>
                            <p className="text-[10px] text-gray-400">tham gia nhóm học tập</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                </div>

                {/* Nút đóng màu đen */}
                <div className="p-4 pt-2 bg-white">
                    <button 
                        onClick={() => setIsDocsModalOpen(false)}
                        className="w-full py-3 bg-gray-900 hover:bg-black text-white text-sm font-bold rounded-xl shadow-lg transition-transform active:scale-95"
                    >
                        ĐÓNG
                    </button>
                </div>

            </div>
        </div>
      )}

{/* --- MODAL (POPUP) XÁC NHẬN IN --- */}
{isPrintModalOpen && (
  <div className="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
    {/* Hộp nội dung chính */}
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden relative animate-in zoom-in-95 duration-200 border border-gray-200">
      
      {/* 1. NÚT ĐÓNG (X) MÀU ĐỎ Ở GÓC PHẢI */}
      <button 
        onClick={() => setIsPrintModalOpen(false)}
        className="absolute top-3 right-3 p-2 bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-600 rounded-full transition-colors z-10 group"
        title="Đóng"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="group-hover:rotate-90 transition-transform"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>

      {/* 2. NỘI DUNG CẢNH BÁO */}
      <div className="p-6 flex flex-col items-center text-center">
        
        {/* Icon trang trí */}
        <div className="w-14 h-14 bg-yellow-50 text-yellow-500 rounded-full flex items-center justify-center mb-4 border border-yellow-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>

        <h3 className="text-xl font-bold text-gray-800 mb-2">LƯU Ý QUAN TRỌNG</h3>
        
        <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-sm text-blue-800 leading-relaxed text-left w-full">
          <p className="font-bold mb-2 flex items-center gap-1">
             <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             Để bản in đẹp nhất:
          </p>
          <ul className="list-disc list-inside space-y-1.5 ml-1">
            <li>Nên dùng <b>Máy tính (PC/Laptop)</b>.</li>
            <li>Trình duyệt khuyên dùng: <b>Google Chrome</b>.</li>
            <li>Không nên dùng <b>iphone</b>.</li>
          </ul>
        </div>

        {/* 3. NÚT IN THẬT SỰ (NẰM TRONG KHUNG) */}
        <button 
          onClick={() => {
            setIsPrintModalOpen(false); // Đóng khung này
            onPrint(); // Gọi lệnh in của hệ thống
          }}
          className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
          TIẾN HÀNH IN/LƯU NGAY
        </button>

      </div>
    </div>
  </div>
)}

                </div>
            </div>
            
            {/* GIAO DIỆN THANH LOADING (Overlay) */}
            {isLoading && (
              <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
                <div className="w-72 p-6 bg-white rounded-2xl shadow-2xl border border-indigo-50 animate-in fade-in zoom-in duration-300">
                  <div className="flex justify-between items-end mb-2">
                    <span className="text-xs font-bold text-indigo-600 uppercase tracking-wider animate-pulse">
                      Đang nạp dữ liệu...
                    </span>
                    <span className="text-sm font-black text-indigo-600">{progress}%</span>
                  </div>
                  
                  <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                    <div 
                      className="bg-indigo-600 h-full rounded-full transition-all duration-300 ease-out shadow-[0_0_10px_rgba(79,70,229,0.5)]"
                      style={{ width: `${progress}%` }}
                    ></div>
                  </div>
                  
                  <p className="text-[10px] text-gray-400 mt-3 text-center italic">
                    Hệ thống đang xử lý, vui lòng đợi giây lát...
                  </p>
                </div>
              </div>
            )}
            
          </div>
        );
      };
     const App = () => {
  // --- Các state cũ giữ nguyên ---
  const [isCafeModalOpen, setIsCafeModalOpen] = useState(false);
  const [showMobilePreview, setShowMobilePreview] = useState(false);
  const [isConfigOpen, setIsConfigOpen] = React.useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  // State cấu hình mặc định
  const [config, setConfig] = useState({ 
      text: '', fontSize: 35, traceCount: 9, verticalOffset: -3, 
      traceOpacity: 0.15, guideScale: 1.02, guideX: 0, guideY: 0.5, 
      gridOpacity: 0.8, gridType: 'cross', fontFamily: "'Klee One', cursive", 
      showOnKun: false 
  });
  
  const [showPostPrintDonate, setShowPostPrintDonate] = useState(false);
  
  // --- PHẦN MỚI: State chứa dữ liệu tải về ---
  const [dbData, setDbData] = useState(null);
  const [isDbLoaded, setIsDbLoaded] = useState(false);

  // 1. Dùng useEffect để tải dữ liệu ngay khi mở web
  useEffect(() => {
      fetchDataFromGithub().then(data => {
          if (data) {
              setDbData(data);     // Lưu dữ liệu vào state
              setIsDbLoaded(true); // Báo hiệu đã tải xong
          }
      });
  }, []);

  // 2. Logic xử lý cuộn trang khi hiện popup (giữ nguyên)
  useEffect(() => {
      if (showPostPrintDonate) document.body.style.overflow = 'hidden';
      else document.body.style.overflow = 'unset';
      return () => { document.body.style.overflow = 'unset'; };
  }, [showPostPrintDonate]);

  /*useEffect(() => {
      if (!config.text || config.text.trim().length === 0) setShowMobilePreview(false);
  }, [config.text]); */
  // ------------------------------

  // 3. Logic phân trang (giữ nguyên)
  const pages = useMemo(() => {
      const contentToShow = (config.text && config.text.trim().length > 0) ? config.text : "日本語"; 
      const chars = Array.from(contentToShow).filter(c => c.trim().length > 0);
      const chunks = [];
      const ROWS_PER_PAGE = 10;
      for (let i = 0; i < chars.length; i += ROWS_PER_PAGE) { chunks.push(chars.slice(i, i + ROWS_PER_PAGE)); }
      if (chunks.length === 0) return [[]];
      return chunks;
  }, [config.text]);

  // 4. Logic in ấn (giữ nguyên)
  const handlePrint = () => {
      const handleAfterPrint = () => { setShowPostPrintDonate(true); window.removeEventListener("afterprint", handleAfterPrint); };
      window.addEventListener("afterprint", handleAfterPrint);
      window.print();
  };

  // --- MÀN HÌNH CHỜ (LOADING) ---
  // Nếu dữ liệu chưa tải xong, hiện màn hình xoay vòng tròn
  if (!isDbLoaded) {
      return (
          <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
              <div className="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
              <p className="text-gray-500 font-bold animate-pulse">Đang tải dữ liệu Kanji...</p>
          </div>
      );
  }

  // --- GIAO DIỆN CHÍNH (Khi đã có dữ liệu) ---
  return (
    <div className="min-h-screen flex flex-col md:flex-row print-layout-reset">
      <div className="no-print z-50">
        <Sidebar 
          config={config} onChange={setConfig} onPrint={handlePrint} 
          isMenuOpen={isMenuOpen} setIsMenuOpen={setIsMenuOpen}
          isConfigOpen={isConfigOpen} setIsConfigOpen={setIsConfigOpen}
          isCafeModalOpen={isCafeModalOpen} setIsCafeModalOpen={setIsCafeModalOpen} 
          showMobilePreview={showMobilePreview} setShowMobilePreview={setShowMobilePreview}
          
          dbData={dbData} // <--- QUAN TRỌNG: Truyền dữ liệu xuống Sidebar
        />
      </div>

      <div id="preview-area" className={`flex-1 bg-gray-100 p-0 md:p-8 overflow-auto flex-col items-center min-h-screen print-layout-reset custom-scrollbar ${showMobilePreview ? 'flex' : 'hidden md:flex'}`}>
        {pages.map((pageChars, index) => (
          <Page 
            key={index} 
            chars={pageChars} 
            config={config} 
            
            dbData={dbData} // <--- QUAN TRỌNG: Truyền dữ liệu xuống page 
          /> 
        ))}
      </div>

      {/* Popup Donate  */}
      {showPostPrintDonate && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-300 no-print">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative animate-in zoom-in-95 duration-300 border border-orange-100">
            <button onClick={() => setShowPostPrintDonate(false)} className="absolute top-3 right-3 p-1.5 bg-gray-100 hover:bg-red-100 hover:text-red-500 rounded-full transition-colors z-10">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div className="p-6 flex flex-col items-center text-center">
              <h3 className="text-xl font-bold text-gray-800 mb-2">BẠN TẠO ĐƯỢC FILE CHƯA?</h3>
              <p className="text-sm text-gray-500 mb-6 leading-relaxed">Nếu bạn thấy trang web hữu ích <br/> hãy mời mình một ly cafe nhé!</p>
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-3 rounded-xl shadow-inner border border-orange-200 mb-4">
                <img src="https://i.ibb.co/JWGwcTL1/3381513652021492183.jpg" alt="QR Donate" className="w-40 h-auto rounded-lg mix-blend-multiply" />
              </div>
              <p className="text-[11px] font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full mb-4">MB BANK: 99931082002</p>
              <button onClick={() => setShowPostPrintDonate(false)} className="w-full py-2.5 bg-gray-800 hover:bg-gray-900 text-white text-sm font-bold rounded-xl transition-all shadow-lg active:scale-95">Lần sau nhé!</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
